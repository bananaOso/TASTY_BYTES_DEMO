fileVersion: 1
id: 8ce2d9df-b775-4a02-9885-37c61c083c7d
name: PY_LOCATION_TRUCK_ORDERS
operation:
  config:
    dfcmd: |2
          locations_df = snowpark_session.table("CROOD_DEV.TASTY_BYTES_DEMO.STG_LOCATION")
          trucks_df = snowpark_session.table("CROOD_DEV.TASTY_BYTES_DEMO.STG_TRUCK")
          orders_df = snowpark_session.table("CROOD_DEV.TASTY_BYTES_DEMO.ORDERS")
          # Join locations with trucks to get truck counts by location
          location_trucks = (
              trucks_df
              .join(
                  locations_df, 
                  trucks_df["PRIMARY_CITY"] == locations_df["CITY"], 
                  "inner"
              )
              # Use simple column names and case-insensitive approach
              .select(
                  locations_df["LOCATION_ID"],
                  locations_df["LOCATION"],
                  locations_df["CITY"],
                  trucks_df["TRUCK_ID"]
              )
              .groupBy("LOCATION_ID", "LOCATION", "CITY")
              .agg(count("TRUCK_ID").alias("TRUCK_COUNT"))
          )

          # Join with order data to get sales metrics
          location_metrics = (
              orders_df
              .join(locations_df, "LOCATION_ID", "inner")
              .groupBy("LOCATION_ID")
              .agg(
                  sum_("ORDER_TOTAL").alias("TOTAL_SALES"),
                  sum_("ORDER_AMOUNT").alias("TOTAL_AMOUNT"),
                  sum_("ORDER_TAX_AMOUNT").alias("TOTAL_TAX")
              )
          )

          # Create a more simplified final version
          joined_df = location_trucks.join(location_metrics, "LOCATION_ID", "left")

          # Add the calculated columns after join to avoid column reference issues
          final_df = (
              joined_df
              .select(
                  col("LOCATION_ID"),
                  col("LOCATION"),
                  col("CITY"),
                  col("TRUCK_COUNT"),
                  # Use coalesce instead of fillna for Column objects
                  coalesce(col("TOTAL_SALES"), lit(0)).alias("TOTAL_SALES"),
                  coalesce(col("TOTAL_AMOUNT"), lit(0)).alias("TOTAL_AMOUNT"),
                  coalesce(col("TOTAL_TAX"), lit(0)).alias("TOTAL_TAX")
              )
          )

          # Add the full location description as a separate step
          final_with_desc = (
              final_df
              .withColumn(
                  "LOCATION_DESCRIPTION", 
                  concat(
                      col("CITY"), 
                      lit(" (Trucks: "), 
                      col("TRUCK_COUNT").cast("string"), 
                      lit(")")
                  )
              )
          )
          df_final = final_with_desc
    pyLib: from snowflake.snowpark.functions import col,lit,concat,count,sum as sum_,coalesce
    writeMode: overwrite
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DW
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ecdb0964-54ab-4a45-88c8-0b0c55d0208f
          stepCounter: 8ce2d9df-b775-4a02-9885-37c61c083c7d
        config: {}
        dataType: NUMBER(19,0)
        description: ""
        name: LOCATION_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0ddfe077-298a-4b21-889e-d97715be581f
                stepCounter: d313c4f8-772c-4557-9278-10255d7bc193
            transform: ""
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DW
            nodeName: ORDERS
          - locationName: DW
            nodeName: STG_LOCATION
          - locationName: DW
            nodeName: STG_TRUCK
        join:
          joinCondition: |-
            FROM {{ ref('DW', 'STG_LOCATION') }} "STG_LOCATION"
            INNER JOIN {{ ref('DW', 'STG_TRUCK') }} "STG_TRUCK"
            ON "STG_LOCATION"./*COLUMN*/ = "STG_TRUCK"./*COLUMN*/
            INNER JOIN {{ ref('DW', 'ORDERS') }} "ORDERS"
            ON "STG_LOCATION"./*COLUMN*/ = "ORDERS"./*COLUMN*/
        name: PY_LOCATION_TRUCK_ORDERS
        noLinkRefs: []
  name: PY_LOCATION_TRUCK_ORDERS
  overrideSQL: false
  schema: ""
  sqlType: "5"
  type: sql
  version: 1
type: Node
